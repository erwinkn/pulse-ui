name: Release

permissions:
  id-token: write  # Required for OIDC

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      js_matrix: ${{ steps.detect.outputs.js_matrix }}
      python_matrix: ${{ steps.detect.outputs.python_matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Detect unpublished versions
        id: detect
        run: |
          python <<'PY'
          import json
          from pathlib import Path
          from urllib.error import HTTPError, URLError
          from urllib.parse import quote
          from urllib.request import urlopen
          try:
              import tomllib  # type: ignore[attr-defined]
          except ModuleNotFoundError:
              import tomli as tomllib  # type: ignore[assignment]

          repo_root = Path(".")

          def fetch_json(url: str) -> dict | None:
              try:
                  with urlopen(url) as response:
                      return json.loads(response.read().decode("utf-8"))
              except HTTPError as exc:
                  if exc.code == 404:
                      return None
                  raise
              except URLError:
                  return None

          js_dirs: set[str] = set()
          python_dirs: set[str] = set()

          js_candidates = [
              path
              for path in repo_root.joinpath("packages").rglob("package.json")
              if "node_modules" not in path.parts
          ]
          python_candidates = [
              path
              for path in repo_root.joinpath("packages").rglob("pyproject.toml")
              if "node_modules" not in path.parts
          ]

          for file_path in js_candidates:
              if not file_path.is_file():
                  continue
              data = json.loads(file_path.read_text())
              if data.get("private"):
                  continue
              name = data.get("name")
              version = data.get("version")
              if not name or not version:
                  continue
              encoded = quote(name, safe="@")
              registry = fetch_json(f"https://registry.npmjs.org/{encoded}")
              if registry is None:
                  js_dirs.add(str(file_path.parent))
                  continue
              if version not in registry.get("versions", {}):
                  js_dirs.add(str(file_path.parent))

          for file_path in python_candidates:
              if not file_path.is_file():
                  continue
              with file_path.open("rb") as fh:
                  data = tomllib.load(fh)
              project = data.get("project", {})
              name = project.get("name")
              version = project.get("version")
              if not name or not version:
                  continue
              registry = fetch_json(f"https://pypi.org/pypi/{name}/json")
              if registry is None:
                  python_dirs.add(str(file_path.parent))
                  continue
              if version not in registry.get("releases", {}):
                  python_dirs.add(str(file_path.parent))

          js_list = sorted(js_dirs)
          python_list = sorted(python_dirs)

          print(f"JavaScript packages to publish (unpublished): {js_list}")
          print(f"Python packages to publish (unpublished): {python_list}")

          import os
          output_path = Path(os.environ["GITHUB_OUTPUT"])
          with output_path.open("a") as fh:
              fh.write(f"js_matrix={json.dumps(js_list)}\n")
              fh.write(f"python_matrix={json.dumps(python_list)}\n")
          PY

  publish_js:
    needs: detect
    if: needs.detect.outputs.js_matrix != '[]'
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'push' && 'release' || 'release-dry-run' }}
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect.outputs.js_matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build JavaScript package
        working-directory: ${{ matrix.package }}
        run: bun run build

      - name: Publish JavaScript package (dry run)
        if: github.event_name != 'push'
        working-directory: ${{ matrix.package }}
        run: npm publish --dry-run --access public --ignore-scripts

      - name: Publish JavaScript package
        if: github.event_name == 'push'
        working-directory: ${{ matrix.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --ignore-scripts

  publish_python:
    needs: detect
    if: needs.detect.outputs.python_matrix != '[]'
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'push' && 'release' || 'release-dry-run' }}
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect.outputs.python_matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Clear dist/ folder
        run: rm -rf dist

      - name: Build Python package
        working-directory: ${{ matrix.package }}
        run: uv build

      - name: Inspect build output
        if: github.event_name != 'push'
        run: ls -R dist

      - name: Publish Python package
        if: github.event_name == 'push'
        run: uv publish
