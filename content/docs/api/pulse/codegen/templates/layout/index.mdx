---
title: layout
---

<PyAttribute name={"LAYOUT_TEMPLATE"} type={null} value={"Template('import { deserialize, extractServerRouteInfo, PulseProvider, type PulseConfig, type PulsePrerender } from \"pulse-ui-client\";\\nimport { Outlet, data, type LoaderFunctionArgs, type ClientLoaderFunctionArgs } from \"react-router\";\\nimport { matchRoutes } from \"react-router\";\\nimport { rrPulseRouteTree } from \"./routes.runtime\";\\nimport { useLoaderData } from \"react-router\";\\n\\n// This config is used to initialize the client\\nexport const config: PulseConfig = {\\n  serverAddress: \"${server_address}\",\\n  apiPrefix: \"${api_prefix}\",\\n  connectionStatus: {\\n    initialConnectingDelay: ${int(connection_status.initial_connecting_delay * 1000)},\\n    initialErrorDelay: ${int(connection_status.initial_error_delay * 1000)},\\n    reconnectErrorDelay: ${int(connection_status.reconnect_error_delay * 1000)},\\n  },\\n};\\n\\n\\n// Server loader: perform initial prerender, abort on first redirect/not-found\\nexport async function loader(args: LoaderFunctionArgs) {\\n  const url = new URL(args.request.url);\\n  const matches = matchRoutes(rrPulseRouteTree, url.pathname) ?? [];\\n  const paths = matches.map(m => m.route.uniquePath);\\n  // Build minimal, safe headers for cross-origin API call\\n  const incoming = args.request.headers;\\n  const fwd = new Headers();\\n  const cookie = incoming.get(\"cookie\");\\n  const authorization = incoming.get(\"authorization\");\\n  if (cookie) fwd.set(\"cookie\", cookie);\\n  if (authorization) fwd.set(\"authorization\", authorization);\\n  fwd.set(\"content-type\", \"application/json\");\\n  const res = await fetch(`${internal_server_address}$${\"{\"}config.apiPrefix}/prerender`, {\\n    method: \"POST\",\\n    headers: fwd,\\n    body: JSON.stringify({ paths, routeInfo: extractServerRouteInfo(args) }),\\n  });\\n  if (!res.ok) throw new Error(\"Failed to prerender batch:\" + res.status);\\n  const body = await res.json();\\n  if (body.redirect) return new Response(null, { status: 302, headers: { Location: body.redirect } });\\n  if (body.notFound) {\\n    console.error(\"Not found:\", url.pathname);\\n    throw new Response(\"Not Found\", { status: 404 });\\n  }\\n  const prerenderData = deserialize(body) as PulsePrerender;\\n  const setCookies =\\n    (res.headers.getSetCookie?.() as string[] | undefined) ??\\n    (res.headers.get(\"set-cookie\") ? [res.headers.get(\"set-cookie\") as string] : []);\\n  const headers = new Headers();\\n  for (const c of setCookies) headers.append(\"Set-Cookie\", c);\\n  return data(prerenderData, { headers });\\n}\\n\\n// Client loader: re-prerender on navigation while reusing renderId\\nexport async function clientLoader(args: ClientLoaderFunctionArgs) {\\n  const url = new URL(args.request.url);\\n  const matches = matchRoutes(rrPulseRouteTree, url.pathname) ?? [];\\n  const paths = matches.map(m => m.route.uniquePath);\\n  const renderId = \\n    typeof window !== \"undefined\" && typeof sessionStorage !== \"undefined\"\\n      ? (sessionStorage.getItem(\"__PULSE_RENDER_ID\") ?? undefined) \\n      : undefined;\\n  const directives = \\n    typeof window !== \"undefined\" && typeof sessionStorage !== \"undefined\"\\n      ? (JSON.parse(sessionStorage.getItem(\"__PULSE_DIRECTIVES\") ?? \"{}\"))\\n      : {};\\n  const headers: HeadersInit = { \"content-type\": \"application/json\" };\\n  if (directives?.headers) {\\n    for (const [key, value] of Object.entries(directives.headers)) {\\n      headers[key] = value as string;\\n    }\\n  }\\n  const res = await fetch(`$${\"{\"}config.serverAddress}$${\"{\"}config.apiPrefix}/prerender`, {\\n    method: \"POST\",\\n    headers,\\n    credentials: \"include\",\\n    body: JSON.stringify({ paths, routeInfo: extractServerRouteInfo(args), renderId }),\\n  });\\n  if (!res.ok) throw new Error(\"Failed to prerender batch:\" + res.status);\\n  const body = await res.json();\\n  if (body.redirect) return new Response(null, { status: 302, headers: { Location: body.redirect } });\\n  if (body.notFound) throw new Response(\"Not Found\", { status: 404 });\\n  const prerenderData = deserialize(body) as PulsePrerender;\\n  if (typeof window !== \"undefined\" && typeof sessionStorage !== \"undefined\" && prerenderData.directives) {\\n    sessionStorage.setItem(\"__PULSE_DIRECTIVES\", JSON.stringify(prerenderData.directives));\\n  }\\n  return prerenderData as PulsePrerender;\\n}\\n\\nexport default function PulseLayout() {\\n  const data = useLoaderData<typeof loader>();\\n  if (typeof window !== \"undefined\" && typeof sessionStorage !== \"undefined\") {\\n    sessionStorage.setItem(\"__PULSE_RENDER_ID\", data.renderId);\\n    sessionStorage.setItem(\"__PULSE_DIRECTIVES\", JSON.stringify(data.directives));\\n  }\\n  return (\\n    <PulseProvider config={config} prerender={data}>\\n      <Outlet />\\n    </PulseProvider>\\n  );\\n}\\n// Persist renderId and directives in sessionStorage for reuse in clientLoader is handled within the component\\n')"} />