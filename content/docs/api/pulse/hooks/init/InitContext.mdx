---
title: InitContext
---

Context manager for one-time initialization in components.

Variables assigned inside the block persist across re-renders. On first render,
the code inside runs normally and variables are captured. On subsequent renders,
the block is skipped and variables are restored from storage.

This class is returned by ``ps.init()`` and should be used as a context manager.

## Attributes

<PyAttribute name={"callsite"} type={"tuple[Any, int] | None"} value={"None"}>

Tuple of (code object, line number) identifying the call site.

</PyAttribute>

<PyAttribute name={"frame"} type={"types.FrameType | None"} value={"None"}>

The stack frame where init was called.

</PyAttribute>

<PyAttribute name={"first_render"} type={"bool"} value={"False"}>

True if this is the first render cycle.

</PyAttribute>

<PyAttribute name={"pre_keys"} type={"set[str]"} value={"set()"}>

Set of variable names that existed before entering the block.

</PyAttribute>

<PyAttribute name={"saved"} type={"dict[str, Any]"} value={"{}"}>

Dictionary of captured variable values.

</PyAttribute>

## Functions

<PyFunction name={"__init__"} type={"(self)"}>

<PySourceCode >

```python
def __init__(self):
	self.callsite = None
	self.frame = None
	self.first_render = False
	self.pre_keys = set()
	self.saved = {}
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />

</div>

<PyFunctionReturn type={null} />

</PyFunction>

<PyFunction name={"__enter__"} type={"(self)"}>

<PySourceCode >

```python
def __enter__(self):
	self.frame = previous_frame()
	self.pre_keys = set(self.frame.f_locals.keys())
	# Use code object to disambiguate identical line numbers in different fns.
	self.callsite = (self.frame.f_code, self.frame.f_lineno)

	storage = _init_hook().storage
	entry = storage.get(self.callsite)
	if entry is None:
		self.first_render = True
		self.saved = {}
	else:
		self.first_render = False
		self.saved = entry["vars"]
	return self
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />

</div>

<PyFunctionReturn type={null} />

</PyFunction>

<PyFunction name={"restore_variables"} type={"(self)"}>

<PySourceCode >

```python
def restore_variables(self):
	if self.first_render:
		return
	frame = self.frame if self.frame is not None else previous_frame()
	frame.f_locals.update(self.saved)
	PyFrame_LocalsToFast(frame, 1)
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />

</div>

<PyFunctionReturn type={null} />

</PyFunction>

<PyFunction name={"save"} type={"(self, values)"}>

<PySourceCode >

```python
def save(self, values: dict[str, Any]):
	self.saved = values
	assert self.callsite is not None, "callsite is None"
	storage = _init_hook().storage
	storage[self.callsite] = {"vars": values}
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />
<PyParameter name={"values"} type={"dict[str, Any]"} value={null} />

</div>

<PyFunctionReturn type={null} />

</PyFunction>

<PyFunction name={"_capture_new_locals"} type={"(self) -> dict[str, Any]"}>

<PySourceCode >

```python
def _capture_new_locals(self) -> dict[str, Any]:
	frame = self.frame
	assert frame is not None, "frame is None"
	captured = {}
	for name, value in frame.f_locals.items():
		if name in self.pre_keys:
			continue
		if value is self:
			continue
		captured[name] = value
	return captured
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />

</div>

<PyFunctionReturn type={"dict[str, typing.Any]"} />

</PyFunction>

<PyFunction name={"__exit__"} type={"(self, exc_type, exc_value, exc_tb) -> Literal[False]"}>

<PySourceCode >

```python
def __exit__(
	self,
	exc_type: type[BaseException] | None,
	exc_value: BaseException | None,
	exc_tb: Any,
) -> Literal[False]:
	if exc_type is None:
		captured = self._capture_new_locals()
		assert self.callsite is not None, "callsite  None"
		storage = _init_hook().storage
		storage[self.callsite] = {"vars": captured}
	self.frame = None
	return False
```

</PySourceCode>

<div >

<PyParameter name={"self"} type={null} value={null} />
<PyParameter name={"exc_type"} type={"type[BaseException] | None"} value={null} />
<PyParameter name={"exc_value"} type={"BaseException | None"} value={null} />
<PyParameter name={"exc_tb"} type={"Any"} value={null} />

</div>

<PyFunctionReturn type={"typing.Literal[False]"} />

</PyFunction>