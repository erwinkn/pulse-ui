# Ralph Progress Log
Started: 2026-01-09

## Codebase Patterns
- Router files: `packages/pulse/js/src/router/`
- Biome formats files on `make all` (tabs, not spaces)

## Key Files
- `packages/pulse/js/src/router/match.ts` - Route matching logic
- `packages/pulse/js/src/router/context.tsx` - Router context provider and types
- `packages/pulse/js/src/router/index.ts` - Router public exports
- `packages/pulse/js/src/router/hash.ts` - Hash scroll utility and hook
- `packages/pulse/js/src/error-boundary.tsx` - React ErrorBoundary component

---

## 2026-01-09 - F-0001
- Created route matcher for static paths
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Created new `router/` directory structure
  - matchPath normalizes trailing slashes for comparison
  - MatchResult type with `matched: boolean` and `params: Record<string, string>`

---

## 2026-01-09 - F-0002
- Added dynamic param matching (:id) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Dynamic params prefixed with `:` (e.g., `:id`, `:userId`)
  - Segment count must match exactly for required params (no extra or missing segments)
  - Tests use `bun:test` with `describe`, `expect`, `it` imports

---

## 2026-01-09 - F-0003
- Added optional segment matching (:id?) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Optional params end with `?` (e.g., `:id?`)
  - MatchResult params type updated to `Record<string, string | undefined>` for optional params
  - Count required segments to determine minimum path length
  - Optional params return `undefined` when not provided (not empty string)

---

## 2026-01-09 - F-0004
- Added catch-all matching (*) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Catch-all `*` captures remaining path segments as `string[]`
  - MatchResult params type expanded to `Record<string, string | undefined | string[]>`
  - Catch-all must be the last segment (validated, returns `matched: false` otherwise)
  - Empty path after prefix returns `{ '*': [] }` (empty array, not undefined)
  - Works with dynamic params before catch-all (e.g., `/users/:id/*`)

---

## 2026-01-09 - F-0005
- Added per-segment specificity comparison
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Specificity ranking: static (3) > dynamic (2) > optional (1) > catch-all (0)
  - `compareRoutes(a, b)` returns -1/0/1 like sort comparator (a wins = -1)
  - `selectBestMatch` iterates routes and picks most specific match
  - RouteMatch<T> interface allows typed route objects with generic parameter
  - Comparison is segment-by-segment; first differing segment determines winner

---

## 2026-01-09 - F-0006
- Created integration test for route matching
- Files: `packages/pulse/js/src/router/__tests__/match.integration.test.ts`
- **Learnings:**
  - Integration tests go in `__tests__/` subdirectory with `.integration.test.ts` suffix
  - Longer patterns (even with optional segments) are more specific than shorter ones
  - Root catch-all `/*` matches `/` with empty array, so avoid using with static `/` route
  - `it.each()` from bun:test supports parameterized tests with `$variable` syntax
  - Steel wire checkpoint: route matching is foundation for router context and navigation

---

## 2026-01-09 - F-0007
- Created PulseRouterContext provider
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Context types: `Location` (pathname, search, hash, state), `Params` (matches MatchResult params type)
  - `NavigateFn` is overloaded: accepts `(to: string, options?)` or `(delta: number)` for history nav
  - `usePulseRouterContext()` internal hook throws if outside provider (used by future hooks)
  - PulseRouterProvider takes location, params, navigate as props (will be injected by Python)

---

## 2026-01-09 - F-0008
- Implemented useLocation hook
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useLocation()` returns full Location object via `usePulseRouterContext().location`
  - Hook tests use `@testing-library/react` with `renderHook`
  - Test wrapper pattern: create factory function returning wrapper component with provider
  - Context tests live alongside implementation (context.test.tsx) not in __tests__ subdirectory

---

## 2026-01-09 - F-0009
- Implemented useParams hook returning scoped params from nearest PulseRouterContext
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useParams()` returns `Params` type (Record<string, string | undefined | string[]>)
  - Scoped behavior: nested PulseRouterProviders shadow parent params (React context default)
  - Parent route params accessed via Pulse Context (server-side state), not from client-side router
  - Test for scoped params: nest two providers, verify inner params returned (not merged)

---

## 2026-01-09 - F-0010
- Implemented useNavigate hook with relative path resolution
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useNavigate()` wraps the context's navigate fn to resolve relative paths client-side
  - `resolvePath(to, basePath)` handles: absolute `/path`, relative `../sibling`, `./child`, `child`
  - History navigation `navigate(-1)` passes through directly to context navigate
  - Mock functions for tests: `mock(() => {}) as unknown as NavigateFn`
  - Biome auto-fixes string concat to template literals on `make all`

---

## 2026-01-09 - F-0011
- Created integration tests verifying nested PulseRouterProviders (simulating layout > page)
- Files: `packages/pulse/js/src/router/__tests__/context.integration.test.tsx`
- **Learnings:**
  - React context shadowing: inner provider completely replaces outer provider's value
  - Params are scoped (not merged) - child sees only its own params, parent params via Pulse Context
  - Location can differ between levels (unusual but valid) - nearest provider wins
  - Navigate from any level uses nearest provider's navigate function
  - 3+ levels work identically - always deepest provider wins
  - Test mixed param types: catch-all `*` arrays, optional `undefined`, regular strings
  - `"key" in object` returns true even if value is undefined (useful for optional param tests)

---

## 2026-01-09 - F-0012
- Created Link component skeleton with click interception
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Link extends `AnchorHTMLAttributes<HTMLAnchorElement>` with Omit for href (require it)
  - Don't intercept modified clicks (metaKey, altKey, ctrlKey, shiftKey) to allow new tab behavior
  - Check `e.defaultPrevented` after calling user's onClick to respect prevented clicks
  - LinkProps includes `replace` and `state` for NavigateOptions passthrough

---

## 2026-01-09 - F-0013
- Added external link detection to Link component
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `isExternalUrl()` checks if URL starts with `http://` or `https://` and has different origin
  - External links render without the click handler (skip `handleClick`, just pass through `onClick`)
  - `window.location.origin` in happy-dom is dynamic - use it directly in tests, don't hardcode
  - Malformed URLs (e.g., `https://`) are treated as external for safety (try/catch around `new URL()`)
  - Use `fireEvent.click` from `@testing-library/react` (not `userEvent` which isn't installed)

---

## 2026-01-09 - F-0014
- Added viewport prefetch using IntersectionObserver to Link component
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`
- **Learnings:**
  - IntersectionObserver fires callback when element enters/exits viewport
  - Use `useRef(false)` to track if prefetch already fired (prevents double-fire)
  - Observer must be disconnected in useEffect cleanup to prevent memory leaks
  - Mock IntersectionObserver in tests using class that stores instances array
  - happy-dom sets `window.location.origin` to `https://example.com` - use different domain for external link tests
  - Call `cleanup()` from @testing-library/react before each test to ensure test isolation
  - `spyOn(console, "log").mockImplementation(() => {})` suppresses console.log output in tests

---

## 2026-01-09 - F-0015
- Added hover prefetch fallback when viewport prefetch is disabled
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`
- **Learnings:**
  - Hover prefetch fires on `mouseenter` event when `prefetch={false}`
  - Reuse `prefetchedRef` to ensure prefetch fires only once (same ref used by viewport prefetch)
  - Extract `triggerPrefetch()` helper to share logic between viewport and hover prefetch
  - Must pass user's `onMouseEnter` handler through: destructure from props, call before prefetch logic
  - `fireEvent.mouseEnter()` from @testing-library/react to test hover behavior

---

## 2026-01-09 - F-0016
- Created NavigationProgress component with provider/context pattern
- Files: `packages/pulse/js/src/router/progress.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Progress indicator uses separate context (`NavigationProgressContext`) for navigation state
  - `NavigationProgressProvider` wraps app and provides `isNavigating`, `startNavigation`, `completeNavigation`
  - `NavigationProgress` component renders thin fixed bar at top with z-index 9999
  - Animation: exponential slowdown from 0% to ~90%, then immediate 100% on completion
  - Use `useRef` for intervals/timeouts, define cleanup inside useEffect to satisfy exhaustive-deps
  - Extract `isNavigating = progressCtx?.isNavigating ?? false` outside effect to simplify dependencies
  - `pointerEvents: "none"` on container so bar doesn't block clicks

---

## 2026-01-09 - F-0017
- Created integration tests for Link component and NavigationProgress
- Files: `packages/pulse/js/src/router/__tests__/link.integration.test.tsx`, `packages/pulse/js/src/router/context.tsx`
- **Learnings:**
  - happy-dom returns hex color format (e.g., `#0070f3`), not rgb format like jsdom
  - MockIntersectionObserver static instances array can pollute across test blocks; test behavior instead
  - Test NavigationProgress visibility via `[style*="position: fixed"]` selector
  - Use `act()` wrapper around state-changing operations like `fireEvent.click` for async updates
  - `waitFor` useful for testing async state changes with configurable timeout
  - Steel wire checkpoint: Link + NavigationProgress components complete and verified

---

## 2026-01-09 - F-0018
- Added hash scroll support with `scrollToHash()` utility and `useHashScroll()` hook
- Files: `packages/pulse/js/src/router/hash.ts`, `packages/pulse/js/src/router/hash.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `scrollToHash(hash)` strips `#` prefix and calls `element.scrollIntoView({ behavior: "smooth" })`
  - `useHashScroll()` hook tracks `location.hash` and scrolls on change (initial load + navigation)
  - Use `requestAnimationFrame` to delay scroll until DOM is ready after navigation
  - `useRef` to track previous hash prevents double-scrolling on re-renders
  - Test stateful wrapper pattern: define `let setHashExternal` outside wrapper, assign inside useState, call in test
  - Wrap state updates in `act()` when testing hooks to avoid React warning

---

## 2026-01-09 - F-0019
- Exported router as public API from main package entry point
- Files: `packages/pulse/js/src/index.ts`
- **Learnings:**
  - Router exports were already complete in `router/index.ts`
  - Main package `index.ts` needed re-exports for router to be accessible via `import { Link } from 'pulse-ui-client'`
  - Alphabetize exports to match Biome formatting expectations

---

## 2026-01-09 - F-0020
- Created React ErrorBoundary class component for catching JavaScript errors
- Files: `packages/pulse/js/src/error-boundary.tsx`, `packages/pulse/js/src/index.ts`
- **Learnings:**
  - React ErrorBoundary must be a class component (cannot use hooks for error catching)
  - TypeScript requires `override` modifier on `componentDidCatch` and `render` methods
  - `getDerivedStateFromError` is static method that updates state when error caught
  - `componentDidCatch` is instance method for side effects like logging
  - Reset function uses arrow function syntax to auto-bind `this`
  - Default fallback UI uses inline styles for CSS-framework-independence

---

## 2026-01-09 - F-0021
- Created DefaultErrorFallback component extracted from ErrorBoundary
- Files: `packages/pulse/js/src/error-boundary.tsx`, `packages/pulse/js/src/index.ts`
- **Learnings:**
  - `process.env.NODE_ENV !== "production"` detects dev mode for showing stack traces
  - Stack trace displayed in `<pre>` with `whiteSpace: pre-wrap` and `wordBreak: break-word` for long lines
  - Button text changed from "Try again" to "Retry" per acceptance criteria
  - Export both component and props type (`DefaultErrorFallbackProps`) for consumers

---
