# Ralph Progress Log
Started: 2026-01-09

## Codebase Patterns
- Router files: `packages/pulse/js/src/router/`
- Biome formats files on `make all` (tabs, not spaces)

## Key Files
- `packages/pulse/js/src/router/match.ts` - Route matching logic
- `packages/pulse/js/src/router/context.tsx` - Router context provider and types
- `packages/pulse/js/src/router/index.ts` - Router public exports
- `packages/pulse/js/src/router/hash.ts` - Hash scroll utility and hook
- `packages/pulse/js/src/error-boundary.tsx` - React ErrorBoundary component
- `packages/pulse/js/src/__tests__/error-boundary.test.tsx` - ErrorBoundary integration tests
- `packages/pulse/js/src/server/server.ts` - Bun SSR render server
- `packages/pulse/js/src/server/render.tsx` - SSR renderVdom function, defaultComponentRegistry, resolveComponent
- `packages/pulse/js/src/server/render.test.tsx` - SSR component registry tests
- `packages/pulse/js/src/server/__tests__/render.test.tsx` - SSR integration tests (simple/nested VDOM, props)
- `packages/pulse/python/src/pulse/error_boundary.py` - Python ErrorBoundary component for server-side error catching

## In Progress
<!-- Partial work from interrupted sessions. Next iteration MUST continue this. -->

---

## 2026-01-09 - F-0001
- Created route matcher for static paths
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Created new `router/` directory structure
  - matchPath normalizes trailing slashes for comparison
  - MatchResult type with `matched: boolean` and `params: Record<string, string>`

---

## 2026-01-09 - F-0002
- Added dynamic param matching (:id) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Dynamic params prefixed with `:` (e.g., `:id`, `:userId`)
  - Segment count must match exactly for required params (no extra or missing segments)
  - Tests use `bun:test` with `describe`, `expect`, `it` imports

---

## 2026-01-09 - F-0003
- Added optional segment matching (:id?) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Optional params end with `?` (e.g., `:id?`)
  - MatchResult params type updated to `Record<string, string | undefined>` for optional params
  - Count required segments to determine minimum path length
  - Optional params return `undefined` when not provided (not empty string)

---

## 2026-01-09 - F-0004
- Added catch-all matching (*) to matchPath
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`
- **Learnings:**
  - Catch-all `*` captures remaining path segments as `string[]`
  - MatchResult params type expanded to `Record<string, string | undefined | string[]>`
  - Catch-all must be the last segment (validated, returns `matched: false` otherwise)
  - Empty path after prefix returns `{ '*': [] }` (empty array, not undefined)
  - Works with dynamic params before catch-all (e.g., `/users/:id/*`)

---

## 2026-01-09 - F-0005
- Added per-segment specificity comparison
- Files: `packages/pulse/js/src/router/match.ts`, `packages/pulse/js/src/router/match.test.ts`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Specificity ranking: static (3) > dynamic (2) > optional (1) > catch-all (0)
  - `compareRoutes(a, b)` returns -1/0/1 like sort comparator (a wins = -1)
  - `selectBestMatch` iterates routes and picks most specific match
  - RouteMatch<T> interface allows typed route objects with generic parameter
  - Comparison is segment-by-segment; first differing segment determines winner

---

## 2026-01-09 - F-0006
- Created integration test for route matching
- Files: `packages/pulse/js/src/router/__tests__/match.integration.test.ts`
- **Learnings:**
  - Integration tests go in `__tests__/` subdirectory with `.integration.test.ts` suffix
  - Longer patterns (even with optional segments) are more specific than shorter ones
  - Root catch-all `/*` matches `/` with empty array, so avoid using with static `/` route
  - `it.each()` from bun:test supports parameterized tests with `$variable` syntax
  - Steel wire checkpoint: route matching is foundation for router context and navigation

---

## 2026-01-09 - F-0007
- Created PulseRouterContext provider
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Context types: `Location` (pathname, search, hash, state), `Params` (matches MatchResult params type)
  - `NavigateFn` is overloaded: accepts `(to: string, options?)` or `(delta: number)` for history nav
  - `usePulseRouterContext()` internal hook throws if outside provider (used by future hooks)
  - PulseRouterProvider takes location, params, navigate as props (will be injected by Python)

---

## 2026-01-09 - F-0008
- Implemented useLocation hook
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useLocation()` returns full Location object via `usePulseRouterContext().location`
  - Hook tests use `@testing-library/react` with `renderHook`
  - Test wrapper pattern: create factory function returning wrapper component with provider
  - Context tests live alongside implementation (context.test.tsx) not in __tests__ subdirectory

---

## 2026-01-09 - F-0009
- Implemented useParams hook returning scoped params from nearest PulseRouterContext
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useParams()` returns `Params` type (Record<string, string | undefined | string[]>)
  - Scoped behavior: nested PulseRouterProviders shadow parent params (React context default)
  - Parent route params accessed via Pulse Context (server-side state), not from client-side router
  - Test for scoped params: nest two providers, verify inner params returned (not merged)

---

## 2026-01-09 - F-0010
- Implemented useNavigate hook with relative path resolution
- Files: `packages/pulse/js/src/router/context.tsx`, `packages/pulse/js/src/router/context.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `useNavigate()` wraps the context's navigate fn to resolve relative paths client-side
  - `resolvePath(to, basePath)` handles: absolute `/path`, relative `../sibling`, `./child`, `child`
  - History navigation `navigate(-1)` passes through directly to context navigate
  - Mock functions for tests: `mock(() => {}) as unknown as NavigateFn`
  - Biome auto-fixes string concat to template literals on `make all`

---

## 2026-01-09 - F-0011
- Created integration tests verifying nested PulseRouterProviders (simulating layout > page)
- Files: `packages/pulse/js/src/router/__tests__/context.integration.test.tsx`
- **Learnings:**
  - React context shadowing: inner provider completely replaces outer provider's value
  - Params are scoped (not merged) - child sees only its own params, parent params via Pulse Context
  - Location can differ between levels (unusual but valid) - nearest provider wins
  - Navigate from any level uses nearest provider's navigate function
  - 3+ levels work identically - always deepest provider wins
  - Test mixed param types: catch-all `*` arrays, optional `undefined`, regular strings
  - `"key" in object` returns true even if value is undefined (useful for optional param tests)

---

## 2026-01-09 - F-0012
- Created Link component skeleton with click interception
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Link extends `AnchorHTMLAttributes<HTMLAnchorElement>` with Omit for href (require it)
  - Don't intercept modified clicks (metaKey, altKey, ctrlKey, shiftKey) to allow new tab behavior
  - Check `e.defaultPrevented` after calling user's onClick to respect prevented clicks
  - LinkProps includes `replace` and `state` for NavigateOptions passthrough

---

## 2026-01-09 - F-0013
- Added external link detection to Link component
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `isExternalUrl()` checks if URL starts with `http://` or `https://` and has different origin
  - External links render without the click handler (skip `handleClick`, just pass through `onClick`)
  - `window.location.origin` in happy-dom is dynamic - use it directly in tests, don't hardcode
  - Malformed URLs (e.g., `https://`) are treated as external for safety (try/catch around `new URL()`)
  - Use `fireEvent.click` from `@testing-library/react` (not `userEvent` which isn't installed)

---

## 2026-01-09 - F-0014
- Added viewport prefetch using IntersectionObserver to Link component
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`
- **Learnings:**
  - IntersectionObserver fires callback when element enters/exits viewport
  - Use `useRef(false)` to track if prefetch already fired (prevents double-fire)
  - Observer must be disconnected in useEffect cleanup to prevent memory leaks
  - Mock IntersectionObserver in tests using class that stores instances array
  - happy-dom sets `window.location.origin` to `https://example.com` - use different domain for external link tests
  - Call `cleanup()` from @testing-library/react before each test to ensure test isolation
  - `spyOn(console, "log").mockImplementation(() => {})` suppresses console.log output in tests

---

## 2026-01-09 - F-0015
- Added hover prefetch fallback when viewport prefetch is disabled
- Files: `packages/pulse/js/src/router/link.tsx`, `packages/pulse/js/src/router/link.test.tsx`
- **Learnings:**
  - Hover prefetch fires on `mouseenter` event when `prefetch={false}`
  - Reuse `prefetchedRef` to ensure prefetch fires only once (same ref used by viewport prefetch)
  - Extract `triggerPrefetch()` helper to share logic between viewport and hover prefetch
  - Must pass user's `onMouseEnter` handler through: destructure from props, call before prefetch logic
  - `fireEvent.mouseEnter()` from @testing-library/react to test hover behavior

---

## 2026-01-09 - F-0016
- Created NavigationProgress component with provider/context pattern
- Files: `packages/pulse/js/src/router/progress.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - Progress indicator uses separate context (`NavigationProgressContext`) for navigation state
  - `NavigationProgressProvider` wraps app and provides `isNavigating`, `startNavigation`, `completeNavigation`
  - `NavigationProgress` component renders thin fixed bar at top with z-index 9999
  - Animation: exponential slowdown from 0% to ~90%, then immediate 100% on completion
  - Use `useRef` for intervals/timeouts, define cleanup inside useEffect to satisfy exhaustive-deps
  - Extract `isNavigating = progressCtx?.isNavigating ?? false` outside effect to simplify dependencies
  - `pointerEvents: "none"` on container so bar doesn't block clicks

---

## 2026-01-09 - F-0017
- Created integration tests for Link component and NavigationProgress
- Files: `packages/pulse/js/src/router/__tests__/link.integration.test.tsx`, `packages/pulse/js/src/router/context.tsx`
- **Learnings:**
  - happy-dom returns hex color format (e.g., `#0070f3`), not rgb format like jsdom
  - MockIntersectionObserver static instances array can pollute across test blocks; test behavior instead
  - Test NavigationProgress visibility via `[style*="position: fixed"]` selector
  - Use `act()` wrapper around state-changing operations like `fireEvent.click` for async updates
  - `waitFor` useful for testing async state changes with configurable timeout
  - Steel wire checkpoint: Link + NavigationProgress components complete and verified

---

## 2026-01-09 - F-0018
- Added hash scroll support with `scrollToHash()` utility and `useHashScroll()` hook
- Files: `packages/pulse/js/src/router/hash.ts`, `packages/pulse/js/src/router/hash.test.tsx`, `packages/pulse/js/src/router/index.ts`
- **Learnings:**
  - `scrollToHash(hash)` strips `#` prefix and calls `element.scrollIntoView({ behavior: "smooth" })`
  - `useHashScroll()` hook tracks `location.hash` and scrolls on change (initial load + navigation)
  - Use `requestAnimationFrame` to delay scroll until DOM is ready after navigation
  - `useRef` to track previous hash prevents double-scrolling on re-renders
  - Test stateful wrapper pattern: define `let setHashExternal` outside wrapper, assign inside useState, call in test
  - Wrap state updates in `act()` when testing hooks to avoid React warning

---

## 2026-01-09 - F-0019
- Exported router as public API from main package entry point
- Files: `packages/pulse/js/src/index.ts`
- **Learnings:**
  - Router exports were already complete in `router/index.ts`
  - Main package `index.ts` needed re-exports for router to be accessible via `import { Link } from 'pulse-ui-client'`
  - Alphabetize exports to match Biome formatting expectations

---

## 2026-01-09 - F-0020
- Created React ErrorBoundary class component for catching JavaScript errors
- Files: `packages/pulse/js/src/error-boundary.tsx`, `packages/pulse/js/src/index.ts`
- **Learnings:**
  - React ErrorBoundary must be a class component (cannot use hooks for error catching)
  - TypeScript requires `override` modifier on `componentDidCatch` and `render` methods
  - `getDerivedStateFromError` is static method that updates state when error caught
  - `componentDidCatch` is instance method for side effects like logging
  - Reset function uses arrow function syntax to auto-bind `this`
  - Default fallback UI uses inline styles for CSS-framework-independence

---

## 2026-01-09 - F-0021
- Created DefaultErrorFallback component extracted from ErrorBoundary
- Files: `packages/pulse/js/src/error-boundary.tsx`, `packages/pulse/js/src/index.ts`
- **Learnings:**
  - `process.env.NODE_ENV !== "production"` detects dev mode for showing stack traces
  - Stack trace displayed in `<pre>` with `whiteSpace: pre-wrap` and `wordBreak: break-word` for long lines
  - Button text changed from "Try again" to "Retry" per acceptance criteria
  - Export both component and props type (`DefaultErrorFallbackProps`) for consumers

---

## 2026-01-09 - F-0022
- Added tests for custom fallback support in ErrorBoundary
- Files: `packages/pulse/js/src/error-boundary.test.tsx`
- **Learnings:**
  - Component with return type `: never` for throwing components to satisfy JSX type checking
  - Mock `console.error` during error boundary tests with `suppressConsoleError()` / `restoreConsoleError()` pattern
  - Use `try/finally` to ensure `restoreConsoleError()` runs even if test assertions fail
  - `screen.queryByText()` returns null when not found (use for negative assertions)
  - Conditional throwing pattern: toggle `shouldThrow` variable before calling reset to test recovery

---

## 2026-01-09 - F-0023
- Created integration tests verifying ErrorBoundary catches errors
- Files: `packages/pulse/js/src/__tests__/error-boundary.test.tsx`
- **Learnings:**
  - Integration tests for non-router components go in `src/__tests__/` directory
  - Conditional throwing components must be defined INSIDE test function for closure to work
  - Defining thrower outside and passing `shouldThrow` as prop doesn't work with ErrorBoundary's internal re-render
  - Test patterns: error catching, default fallback, custom fallback, reset recovery, multiple/nested boundaries
  - `beforeEach(() => cleanup())` and `afterEach(() => restoreConsoleError())` for test isolation
  - Steel wire checkpoint: ErrorBoundary integration verified and working

---

## 2026-01-09 - F-0024
- Created Bun render server skeleton with /render and /health endpoints
- Files: `packages/pulse/js/src/server/server.ts`
- **Learnings:**
  - `Bun.serve()` returns server instance with `port` property
  - Port configurable via `PORT` env variable with fallback to 3001
  - Use `process.env.PORT` (not `Bun.env.PORT`) for broader compatibility
  - Server files in `server/` subdirectory alongside client code
  - Placeholder HTML returned for /render, actual rendering logic added in F-0025

---

## 2026-01-09 - F-0025
- Implemented React SSR rendering with renderVdom function
- Files: `packages/pulse/js/src/server/render.tsx`, `packages/pulse/js/src/server/server.ts`
- **Learnings:**
  - `renderToString` from `react-dom/server` for synchronous SSR (not streaming)
  - VDOMRenderer reusable for SSR: create mock client with no-op invokeCallback
  - RouteInfo type holds Location and Params for PulseRouterProvider wrapping
  - SSR navigate is a no-op (navigation only happens on client)
  - Server receives VDOM JSON + optional config, returns HTML string
  - Error handling in /render endpoint returns JSON with error message (status 500)

---

## 2026-01-09 - F-0026
- Added component registry to SSR server
- Files: `packages/pulse/js/src/server/render.tsx`, `packages/pulse/js/src/server/render.test.tsx`
- **Learnings:**
  - `defaultComponentRegistry` maps HTML element names to their string tags for createElement
  - For HTML intrinsic elements, string tag names (e.g., "div") work directly with createElement
  - Custom registry merges with default: `{ ...defaultComponentRegistry, ...config.registry }`
  - `resolveComponent()` utility throws clear error for unknown components
  - Mount point pattern (`$$ComponentName`) resolves from registry in VDOMRenderer
  - Regular tags pass through directly to createElement (no registry lookup needed)

---

## 2026-01-09 - F-0027
- Created integration tests for SSR renderVdom function
- Files: `packages/pulse/js/src/server/__tests__/render.test.tsx`
- **Learnings:**
  - VDOM uses `tag` field (not `type`) per VDOMElement interface
  - TypeScript infers `undefined` for missing props in mixed-shape children arrays; use explicit `: VDOM` type annotation
  - React SSR converts `className` to `class` and `htmlFor` to `for` in output HTML
  - Style objects with camelCase (`fontSize`) convert to kebab-case (`font-size`) in HTML
  - Steel wire checkpoint: basic SSR rendering verified with simple, nested, and props-applied VDOM

---

## 2026-01-10 - F-0028
- Added comprehensive error handling to SSR server
- Files: `packages/pulse/js/src/server/server.ts`, `packages/pulse/js/src/server/__tests__/server.test.ts`
- **Learnings:**
  - Differentiate JSON parse errors (400) from rendering errors (500) using separate try/catch blocks
  - `process.env.NODE_ENV !== "production"` for dev/prod error differentiation
  - Custom `InvalidVDOMError` class for VDOM validation with `name` property set in constructor
  - VDOM validation must be recursive for children arrays
  - Valid VDOM types: null, undefined, boolean, string, number, array, object with `tag` string
  - Test error handling logic directly without network calls when happy-dom blocks HTTP requests

---

## 2026-01-10 - F-0029
- Created Python ErrorBoundary component for server-side error catching
- Files: `packages/pulse/python/src/pulse/error_boundary.py`, `packages/pulse/python/src/pulse/__init__.py`
- **Learnings:**
  - `__slots__` must have type annotation `tuple[str, ...]` to satisfy basedpyright (reportUnannotatedClassAttribute)
  - `RenderError` class captures error message and stack trace, with `from_exception()` factory method
  - `traceback.format_exception(type(exc), exc, exc.__traceback__)` gets full stack trace
  - ErrorBoundary uses `RenderTree` to test-render children and catch errors during VDOM rendering
  - Default fallback matches React ErrorBoundary visual style with red border and dev-mode stack trace
  - `env.pulse_env == "dev"` checks for development mode in Python
  - Export pattern: `from pulse.error_boundary import ErrorBoundary as ErrorBoundary` for public API

---

## 2026-01-10 - F-0030
- Wired Python ErrorBoundary to React ErrorBoundary component
- Files: `packages/pulse/python/src/pulse/renderer.py`, `packages/pulse/js/src/server/render.tsx`, `packages/pulse/python/tests/test_error_boundary.py`
- **Learnings:**
  - Renderer handles ErrorBoundary via `render_error_boundary` method (uses runtime isinstance check to avoid circular import)
  - ErrorBoundary renders as `$$ErrorBoundary` mount point in VDOM (uses MOUNT_PREFIX constant)
  - `client_fallback` prop registered as callback using standard `register_callback` function
  - Return normalized children (not ErrorBoundary) as persistent node since boundary is a wrapper
  - SSR uses `defaultComponentRegistry` - added `ErrorBoundary: ErrorBoundary` mapping
  - Test files can use `Any` type with `# pyright: ignore[reportArgumentType]` for dynamic renderer behavior

---

## 2026-01-10 - F-0031
- Created user-facing Pulse Context system
- Files: `packages/pulse/python/src/pulse/context.py`, `packages/pulse/python/src/pulse/__init__.py`
- **Learnings:**
  - User context system is separate from internal `PulseContext` class (which manages app/session/render/route)
  - Use `ContextVar[tuple[MappingProxyType[str, Any], ...]]` to store stack of immutable context snapshots
  - `MappingProxyType` from `types` module creates immutable dict views
  - Context manager pattern with `token` for push/pop semantics
  - Search reversed stack (innermost to outermost) when looking up keys
  - Clear error message when key not found, suggesting correct usage pattern

---

## 2026-01-10 - F-0032
- Added context inheritance through route hierarchy
- Files: `packages/pulse/python/src/pulse/context.py`, `packages/pulse/python/src/pulse/render_session.py`, `packages/pulse/python/tests/test_context_inheritance.py`
- **Learnings:**
  - `RouteMount` stores `user_context_snapshot` for tracking context per route path
  - `get_user_context_snapshot()` captures current stack, `restore_user_context()` restores from snapshot
  - `RenderSession.get_parent_context_snapshot(route)` looks up parent's mount via `route.parent.unique_path()`
  - Snapshot capture must happen during render (inside `with pulse_context()` block), not after
  - Context managers exit when function returns, so snapshot captured after `render()` is empty
  - Route paths: Layout is `/<layout>`, nested layout is `/<layout>/<layout>`, route is `/routename` (not nested)
  - Callback key format: child index + prop name, e.g., `"0.onClick"` for first child's onClick
  - `prerender()` and `_create_render_effect()` both restore parent context before rendering child routes

---
